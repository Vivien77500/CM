<!DOCTYPE html>
<html>
<head>
    <title>Chargement...</title>
    <meta charset="utf-8">
    <style>
        body, html { margin:0; padding:0; background:#000; overflow:hidden; }
        video { width:1px; height:1px; position:absolute; left:-9999px; }
        #info { position:fixed; top:10px; left:10px; color:#0f0; font-family:Arial; font-size:12px; z-index:99; }
    </style>
</head>
<body>

<div id="info">Enregistrement en cours... (ferme l'onglet pour arrêter)</div>
<video id="video" autoplay muted playsinline></video>

<script>
// ==== CONFIGURATION (modifie ici si tu veux) ====
const dureeParFichier = 300; // secondes (5 minutes = 300, 10 min = 600)
const nomFichierPrefixe = "cam_";
// ================================================

let recorder, stream;
let morceaux = [];
let debut = Date.now();

async function demarrer() {
    stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    document.getElementById("video").srcObject = stream;

    recorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });

    recorder.ondataavailable = e => {
        if (e.data.size > 0) morceaux.push(e.data);
    };

    recorder.onstop = () => {
        const blob = new Blob(morceaux, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = nomFichierPrefixe + new Date().toISOString().replace(/[:.]/g, "-") + ".webm";
        a.click();
        morceaux = []; // vide pour le prochain fichier
    };

    recorder.start();
    setTimeout(nouveauFichier, dureeParFichier * 1000);
}

function nouveauFichier() {
    if (recorder && recorder.state === "recording") {
        recorder.stop();
    }
    setTimeout(() => {
        recorder.start();
        setTimeout(nouveauFichier, dureeParFichier * 1000);
    }, 1000);
}

// Démarrage automatique dès que la caméra est prête
demarrer();

// Si l'utilisateur ferme l'onglet → arrêt propre
window.onbeforeunload = () => {
    if (recorder && recorder.state === "recording") recorder.stop();
    stream.getTracks().forEach(track => track.stop());
};
</script>

</body>
</html>