<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>.</title>
<style>body{background:#000;margin:0;overflow:hidden;color:#0f0;font-family:Arial}</style>
</head><body>

<div id="i">Autorise l'accès au dossier → clique "Autoriser" une seule fois<br>Ensuite tu peux fermer/minimiser la fenêtre</div>

<video id="v" autoplay playsinline style="display:none"></video>

<script>
let stream, recorder, fileHandle, writer;
const dossierTelechargements = "Téléchargements"; // nom exact du dossier dans Windows/Mac/Linux

async function demarrer() {
    // 1. Demande la caméra + micro
    stream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
    document.getElementById("v").srcObject = stream;

    // 2. Demande l'accès AU DOSSIER TÉLÉCHARGEMENTS (une seule fois)
    try {
        const dirHandle = await window.showDirectoryPicker();
        // On vérifie que c’est bien le dossier Téléchargements (sinon tu choisis manuellement)
        fileHandle = await dirHandle.getFileHandle(`CAM_${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.webm`, {create: true});
    } catch(e) {
        alert("Tu dois autoriser l’accès au dossier une fois !");
        return;
    }

    document.getElementById("i").innerHTML = "ENREGISTREMENT EN COURS<br>Tu peux fermer ou minimiser cette fenêtre<br>Les vidéos sont dans ton dossier Téléchargements";

    // 3. Enregistrement continu avec fichier de 10 minutes
    function nouveauFichier() {
        const nom = `CAM_${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.webm`;
        dirHandle.getFileHandle(nom, {create: true}).then(async fh => {
            fileHandle = fh;
            const writable = await fileHandle.createWritable();
            writer = writable;

            recorder = new MediaRecorder(stream, {mimeType: "video/webm;codecs=vp9,opus"});
            
            recorder.ondataavailable = async e => {
                if (e.data.size > 0) {
                    await writer.write(e.data);
                }
            };

            recorder.onstop = async () => {
                await writer.close();
            };

            recorder.start(10000); // chunk toutes les 10 sec = écriture fluide
            setTimeout(() => { recorder.stop(); }, 600000); // 10 minutes = 600000 ms
        });
    }

    nouveauFichier();
    setInterval(nouveauFichier, 602000); // relance toutes les 10 min + 2 sec
}

// Lancement
demarrer();

// Arrêt propre
window.onbeforeunload = () => {
    if (recorder) recorder.stop();
    stream.getTracks().forEach(t => t.stop());
};
</script>

</body></html>